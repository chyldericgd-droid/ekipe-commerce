<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ekipe 6.1 — Boutique</title>

  <!-- CONFIG : adapte si besoin -->
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzWnBWAigG8ZdyvbnwzxD9NgXy23Yl0Csy5d_xW2QtUDBAEbFxKLbeCwEgylH_an-wZ/exec';
    // Si tu utilises API_TOKEN dans Code.gs, tu peux le remplir ici pour tests locaux.
    // NE PAS laisser une clé secrète dans un repo public ! Laisser vide pour GitHub Pages publics.
    const API_TOKEN_IN_CLIENT = ""; // ex: "CLE_TEST_123" (laisser vide si public)
    const MTN_NUMBER = '064131363';
    const AIRTEL_NUMBER = '056067092';
    const FETCH_TIMEOUT_MS = 15000;
  </script>

  <style>
    :root {
      --bg:#f6f7fb;
      --card:#fff;
      --muted:#6b7280;
      --accent:#0b5edd;
      --accent-dark:#074bb3;
      --success:#16a34a;
      --danger:#ef4444;
      font-family: Inter, system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted);font-size:13px}

    .grid{display:flex;flex-wrap:wrap;gap:20px;justify-content:center}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(2,6,23,.06);width:320px;cursor:pointer;transition:transform .12s}
    .card:hover{transform:translateY(-6px)}
    .thumb{height:180px;border-radius:8px;overflow:hidden;background:#f1f5f9;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .card h3{margin:10px 0 6px;font-size:16px}
    .card p{margin:0;color:var(--muted);font-size:14px}

    .form-area{max-width:900px;margin:18px auto;background:rgba(255,255,255,0.98);padding:18px;border-radius:12px;box-shadow:0 18px 40px rgba(2,6,23,.06)}
    .form-row{display:flex;gap:12px;flex-wrap:wrap}
    .left{flex:1;min-width:260px}
    .right{flex:1;min-width:260px}

    label{display:block;margin-top:12px;font-weight:600}
    input[type="text"], input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:white;font-size:15px}
    input:focus, select:focus{outline:none;box-shadow:0 0 0 4px rgba(11,94,221,0.08);border-color:var(--accent)}
    .price-box{background:#e9f7ff;padding:12px;border-left:4px solid var(--accent);border-radius:8px;font-weight:700;margin-top:12px}
    .notice{background:#fff7ed;padding:10px;border-left:4px solid #f59e0b;border-radius:8px;margin-top:12px;color:#92400e}
    .actions{display:flex;gap:12px;margin-top:16px}
    .btn{flex:1;padding:12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:white}
    .btn.ghost{background:transparent;border:1px solid #e6e9ef}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .message{margin-top:12px;padding:10px;border-radius:8px;text-align:center}
    .message.success{background:#e8f9ed;color:var(--success);border:1px solid rgba(22,163,74,.12)}
    .message.error{background:#ffe6e6;color:var(--danger);border:1px solid rgba(255,59,48,.12)}

    .loader{display:inline-block;width:16px;height:16px;border-radius:50%;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--accent);animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.45);z-index:60}
    .modal .card{width:480px;max-width:92vw}

    @media (max-width:800px){ .card{width:100%} .form-row{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Ekipe 6.1 — Boutique</h1>
        <div class="subtitle">Designs — Personnalisation — Paiement Mobile Money</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:var(--muted)">MTN <strong>064131363</strong> • Airtel <strong>056067092</strong></div>
      </div>
    </header>

    <!-- Catalogue -->
    <section class="grid" id="catalogue">
      <article class="card" role="button" onclick="openDetail('T-Shirt Classique','TS-CL001')">
        <div class="thumb"><img src="https://via.placeholder.com/640x360?text=Classique" alt="T-Shirt Classique"></div>
        <h3>T-Shirt Classique</h3>
        <p>Design épuré, confortable — parfait pour le quotidien.</p>
      </article>

      <article class="card" role="button" onclick="openDetail('T-Shirt Géométrique','TS-GE002')">
        <div class="thumb"><img src="https://via.placeholder.com/640x360?text=Géométrique" alt="T-Shirt Géométrique"></div>
        <h3>T-Shirt Géométrique</h3>
        <p>Motifs structurés et modernes.</p>
      </article>
    </section>

    <!-- Détail + Form -->
    <main id="detail-area"></main>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true">
      <h3 id="modal-title">Instructions de paiement</h3>
      <p id="modal-text" style="color:var(--muted)"></p>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn primary" onclick="closeModal()">Fermer</button>
      </div>
    </div>
  </div>

<script>
/* ============ Helpers ============ */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const timeoutFetch = (url, opts = {}, ms = FETCH_TIMEOUT_MS) => {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), ms);
  return fetch(url, {...opts, signal: controller.signal}).finally(() => clearTimeout(id));
};

function showModal(title, text) {
  $('#modal-title').textContent = title;
  $('#modal-text').textContent = text;
  const m = document.getElementById('modal');
  m.style.display = 'flex';
  m.setAttribute('aria-hidden','false');
}
function closeModal(){
  const m = document.getElementById('modal');
  m.style.display = 'none';
  m.setAttribute('aria-hidden','true');
}

/* ============ Catalogue -> Detail ============ */
function openDetail(name, sku) {
  const area = document.getElementById('detail-area');
  area.innerHTML = detailHTML();
  $('#product-name').textContent = name;
  $('#selected-sku').value = sku;
  $('#thumb').src = `https://via.placeholder.com/600x360?text=${encodeURIComponent(sku)}`;
  attachListeners();
  calculatePrice(); // initial
  window.scrollTo({top:0, behavior:'smooth'});
}

function detailHTML(){
  return `
    <section class="form-area" aria-live="polite">
      <div style="display:flex;gap:18px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <img id="thumb" src="" alt="Visuel" style="width:100%;border-radius:8px;object-fit:cover">
        </div>
        <div style="flex:1;min-width:260px">
          <h2 id="product-name">Produit</h2>
          <form id="order-form" onsubmit="event.preventDefault(); submitOrder()">
            <input type="hidden" id="selected-sku" name="sku" value="">
            <label>Quantité *</label>
            <input id="qty" type="number" min="1" value="1" required>

            <label>Qualité *</label>
            <select id="quality" required>
              <option value="T-Shirt Simple">T-Shirt Simple</option>
              <option value="T-Shirt Pro">T-Shirt Pro</option>
              <option value="T-Shirt Max">T-Shirt Max</option>
            </select>

            <label>Fabrication *</label>
            <select id="fabrication" required>
              <option value="Standard">Standard (1500F)</option>
              <option value="Premium">Premium (2000F)</option>
            </select>

            <div class="price-box" id="price-box">Prix de Vente Calculé : —</div>

            <hr style="margin:14px 0">

            <label>Nom complet *</label>
            <input id="client-name" type="text" required>

            <label>Adresse / Ville *</label>
            <input id="city" type="text" required placeholder="Ex: Kinshasa / RETRAIT KM4">

            <label>Opérateur MM *</label>
            <select id="operator" required>
              <option>MTN Money</option>
              <option>Airtel Money</option>
              <option>Moov Money</option>
              <option>Autre</option>
            </select>

            <label>Référence de transaction *</label>
            <input id="trx-ref" type="text" placeholder="Ex: TRX12345" required>

            <div class="notice">Effectuez le paiement avant de soumettre la référence. Si vous indiquez "RETRAIT KM4" comme adresse, la livraison sera gratuite.</div>

            <div class="actions">
              <button type="submit" class="btn primary" id="submit-btn">Confirmer & Envoyer</button>
              <button type="button" class="btn ghost" onclick="showPayment()">Instructions paiement</button>
            </div>

            <div id="message" aria-live="polite"></div>
          </form>
        </div>
      </div>
    </section>
  `;
}

/* ============ Events & API ============ */
let priceTimer = null;
function attachListeners(){
  const form = $('#order-form');
  if (!form) return;
  $('#qty').addEventListener('input', debounce(calculatePrice, 300));
  $('#quality').addEventListener('change', calculatePrice);
  $('#fabrication').addEventListener('change', calculatePrice);
  $('#city').addEventListener('input', debounce(calculatePrice, 500));
}

function debounce(fn, ms){
  return function(...args){
    clearTimeout(priceTimer);
    priceTimer = setTimeout(()=>fn.apply(this,args), ms);
  };
}

async function calculatePrice(){
  try {
    const qty = $('#qty').value || 1;
    const designe = 'Boutique'; // catalog default
    const qual = $('#quality').value;
    const fab = $('#fabrication').value;
    const addr = $('#city').value || '';

    const url = new URL(API_URL);
    url.searchParams.append('action','calculatePrice');
    url.searchParams.append('quantite', qty);
    url.searchParams.append('designe', designe);
    url.searchParams.append('qualite', qual);
    url.searchParams.append('fabrication', fab);
    url.searchParams.append('adresse', addr);

    const priceBox = $('#price-box');
    priceBox.textContent = 'Calcul en cours...';
    priceBox.insertAdjacentHTML('beforeend',' <span class="loader" id="price-loader"></span>');

    const res = await timeoutFetch(url.toString(), { method: 'GET' }, FETCH_TIMEOUT_MS);
    const json = await res.json();

    const loader = $('#price-loader');
    if (loader) loader.remove();

    if (json && json.status === 'success') {
      priceBox.textContent = 'Prix de Vente Calculé : ' + json.price;
    } else {
      priceBox.textContent = 'Erreur de calcul : ' + (json && json.message ? json.message : 'API indisponible');
    }
  } catch (err) {
    const loader = $('#price-loader');
    if (loader) loader.remove();
    $('#price-box').textContent = 'Erreur de connexion au serveur';
    console.error('calculatePrice error', err);
  }
}

async function submitOrder(){
  const btn = $('#submit-btn');
  const messageEl = $('#message');
  const form = $('#order-form');

  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  // build payload
  const payload = {
    token: API_TOKEN_IN_CLIENT || undefined,
    quantite: Number($('#qty').value) || 1,
    designe: 'Boutique',
    qualite: $('#quality').value,
    fabrication: $('#fabrication').value,
    ville: ($('#city').value || '').trim(),
    produit_selectionne: $('#selected-sku').value || '',
    nom_client: ($('#client-name').value || '').trim(),
    operateur: $('#operator').value,
    reference: ($('#trx-ref').value || '').trim()
  };

  // UI feedback
  btn.disabled = true;
  messageEl.innerHTML = '<div class="message" style="background:#f0f7ff;color:var(--accent)">Enregistrement en cours... <span class="loader"></span></div>';

  try {
    const res = await timeoutFetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }, FETCH_TIMEOUT_MS);

    const json = await res.json();
    if (json && json.status === 'success') {
      messageEl.innerHTML = `<div class="message success">${escapeHtml(json.message || 'Commande enregistrée avec succès')}</div>`;
      form.reset();
      $('#price-box').textContent = 'Prix de Vente Calculé : —';
      // show modal with payment reminder
      showModal('Commande enregistrée', `Merci — votre commande a été enregistrée.\n\nSi vous n'avez pas encore payé, envoyez le montant au numéro MTN: ${MTN_NUMBER} ou Airtel: ${AIRTEL_NUMBER} puis collez la référence reçue.`);
      setTimeout(()=>{ messageEl.innerHTML = ''; }, 6000);
    } else {
      messageEl.innerHTML = `<div class="message error">Erreur : ${escapeHtml(json && json.message ? json.message : 'Échec d\'enregistrement')}</div>`;
      console.error('API error', json);
    }
  } catch (err) {
    messageEl.innerHTML = `<div class="message error">Erreur de connexion au serveur. Réessayez.</div>`;
    console.error('submit error', err);
  } finally {
    btn.disabled = false;
  }
}

/* ============ Helpers ============ */
function showPayment(){
  showModal('Instructions paiement', `1) Envoyez le montant au numéro choisi.\n\nMTN: ${MTN_NUMBER}\nAirtel: ${AIRTEL_NUMBER}\n\n2) Après le paiement, copiez la référence reçue dans le champ "Référence de transaction" puis confirmez.`);
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ============ Init ============ */
document.addEventListener('DOMContentLoaded', ()=> {
  // nothing: user navigates via catalogue cards
});
</script>
</body>
</html>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ekipe 6.1 — Boutique</title>

  <!-- CONFIG : adapte si besoin -->
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzWnBWAigG8ZdyvbnwzxD9NgXy23Yl0Csy5d_xW2QtUDBAEbFxKLbeCwEgylH_an-wZ/exec';
    // Si tu utilises API_TOKEN dans Code.gs, tu peux le remplir ici pour tests locaux.
    // NE PAS laisser une clé secrète dans un repo public ! Laisser vide pour GitHub Pages publics.
    const API_TOKEN_IN_CLIENT = ""; // ex: "CLE_TEST_123" (laisser vide si public)
    const MTN_NUMBER = '064131363';
    const AIRTEL_NUMBER = '056067092';
    const FETCH_TIMEOUT_MS = 15000;
  </script>

  <style>
    :root {
      --bg:#f6f7fb;
      --card:#fff;
      --muted:#6b7280;
      --accent:#0b5edd;
      --accent-dark:#074bb3;
      --success:#16a34a;
      --danger:#ef4444;
      font-family: Inter, system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted);font-size:13px}

    .grid{display:flex;flex-wrap:wrap;gap:20px;justify-content:center}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(2,6,23,.06);width:320px;cursor:pointer;transition:transform .12s}
    .card:hover{transform:translateY(-6px)}
    .thumb{height:180px;border-radius:8px;overflow:hidden;background:#f1f5f9;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .card h3{margin:10px 0 6px;font-size:16px}
    .card p{margin:0;color:var(--muted);font-size:14px}

    .form-area{max-width:900px;margin:18px auto;background:rgba(255,255,255,0.98);padding:18px;border-radius:12px;box-shadow:0 18px 40px rgba(2,6,23,.06)}
    .form-row{display:flex;gap:12px;flex-wrap:wrap}
    .left{flex:1;min-width:260px}
    .right{flex:1;min-width:260px}

    label{display:block;margin-top:12px;font-weight:600}
    input[type="text"], input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:white;font-size:15px}
    input:focus, select:focus{outline:none;box-shadow:0 0 0 4px rgba(11,94,221,0.08);border-color:var(--accent)}
    .price-box{background:#e9f7ff;padding:12px;border-left:4px solid var(--accent);border-radius:8px;font-weight:700;margin-top:12px}
    .notice{background:#fff7ed;padding:10px;border-left:4px solid #f59e0b;border-radius:8px;margin-top:12px;color:#92400e}
    .actions{display:flex;gap:12px;margin-top:16px}
    .btn{flex:1;padding:12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:white}
    .btn.ghost{background:transparent;border:1px solid #e6e9ef}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .message{margin-top:12px;padding:10px;border-radius:8px;text-align:center}
    .message.success{background:#e8f9ed;color:var(--success);border:1px solid rgba(22,163,74,.12)}
    .message.error{background:#ffe6e6;color:var(--danger);border:1px solid rgba(255,59,48,.12)}

    .loader{display:inline-block;width:16px;height:16px;border-radius:50%;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--accent);animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.45);z-index:60}
    .modal .card{width:480px;max-width:92vw}

    @media (max-width:800px){ .card{width:100%} .form-row{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Ekipe 6.1 — Boutique</h1>
        <div class="subtitle">Designs — Personnalisation — Paiement Mobile Money</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:var(--muted)">MTN <strong>064131363</strong> • Airtel <strong>056067092</strong></div>
      </div>
    </header>

    <!-- Catalogue -->
    <section class="grid" id="catalogue">
      <article class="card" role="button" onclick="openDetail('T-Shirt Classique','TS-CL001')">
        <div class="thumb"><img src="https://via.placeholder.com/640x360?text=Classique" alt="T-Shirt Classique"></div>
        <h3>T-Shirt Classique</h3>
        <p>Design épuré, confortable — parfait pour le quotidien.</p>
      </article>

      <article class="card" role="button" onclick="openDetail('T-Shirt Géométrique','TS-GE002')">
        <div class="thumb"><img src="https://via.placeholder.com/640x360?text=Géométrique" alt="T-Shirt Géométrique"></div>
        <h3>T-Shirt Géométrique</h3>
        <p>Motifs structurés et modernes.</p>
      </article>
    </section>

    <!-- Détail + Form -->
    <main id="detail-area"></main>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true">
      <h3 id="modal-title">Instructions de paiement</h3>
      <p id="modal-text" style="color:var(--muted)"></p>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn primary" onclick="closeModal()">Fermer</button>
      </div>
    </div>
  </div>

<script>
/* ============ Helpers ============ */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const timeoutFetch = (url, opts = {}, ms = FETCH_TIMEOUT_MS) => {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), ms);
  return fetch(url, {...opts, signal: controller.signal}).finally(() => clearTimeout(id));
};

function showModal(title, text) {
  $('#modal-title').textContent = title;
  $('#modal-text').textContent = text;
  const m = document.getElementById('modal');
  m.style.display = 'flex';
  m.setAttribute('aria-hidden','false');
}
function closeModal(){
  const m = document.getElementById('modal');
  m.style.display = 'none';
  m.setAttribute('aria-hidden','true');
}

/* ============ Catalogue -> Detail ============ */
function openDetail(name, sku) {
  const area = document.getElementById('detail-area');
  area.innerHTML = detailHTML();
  $('#product-name').textContent = name;
  $('#selected-sku').value = sku;
  $('#thumb').src = `https://via.placeholder.com/600x360?text=${encodeURIComponent(sku)}`;
  attachListeners();
  calculatePrice(); // initial
  window.scrollTo({top:0, behavior:'smooth'});
}

function detailHTML(){
  return `
    <section class="form-area" aria-live="polite">
      <div style="display:flex;gap:18px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <img id="thumb" src="" alt="Visuel" style="width:100%;border-radius:8px;object-fit:cover">
        </div>
        <div style="flex:1;min-width:260px">
          <h2 id="product-name">Produit</h2>
          <form id="order-form" onsubmit="event.preventDefault(); submitOrder()">
            <input type="hidden" id="selected-sku" name="sku" value="">
            <label>Quantité *</label>
            <input id="qty" type="number" min="1" value="1" required>

            <label>Qualité *</label>
            <select id="quality" required>
              <option value="T-Shirt Simple">T-Shirt Simple</option>
              <option value="T-Shirt Pro">T-Shirt Pro</option>
              <option value="T-Shirt Max">T-Shirt Max</option>
            </select>

            <label>Fabrication *</label>
            <select id="fabrication" required>
              <option value="Standard">Standard (1500F)</option>
              <option value="Premium">Premium (2000F)</option>
            </select>

            <div class="price-box" id="price-box">Prix de Vente Calculé : —</div>

            <hr style="margin:14px 0">

            <label>Nom complet *</label>
            <input id="client-name" type="text" required>

            <label>Adresse / Ville *</label>
            <input id="city" type="text" required placeholder="Ex: Kinshasa / RETRAIT KM4">

            <label>Opérateur MM *</label>
            <select id="operator" required>
              <option>MTN Money</option>
              <option>Airtel Money</option>
              <option>Moov Money</option>
              <option>Autre</option>
            </select>

            <label>Référence de transaction *</label>
            <input id="trx-ref" type="text" placeholder="Ex: TRX12345" required>

            <div class="notice">Effectuez le paiement avant de soumettre la référence. Si vous indiquez "RETRAIT KM4" comme adresse, la livraison sera gratuite.</div>

            <div class="actions">
              <button type="submit" class="btn primary" id="submit-btn">Confirmer & Envoyer</button>
              <button type="button" class="btn ghost" onclick="showPayment()">Instructions paiement</button>
            </div>

            <div id="message" aria-live="polite"></div>
          </form>
        </div>
      </div>
    </section>
  `;
}

/* ============ Events & API ============ */
let priceTimer = null;
function attachListeners(){
  const form = $('#order-form');
  if (!form) return;
  $('#qty').addEventListener('input', debounce(calculatePrice, 300));
  $('#quality').addEventListener('change', calculatePrice);
  $('#fabrication').addEventListener('change', calculatePrice);
  $('#city').addEventListener('input', debounce(calculatePrice, 500));
}

function debounce(fn, ms){
  return function(...args){
    clearTimeout(priceTimer);
    priceTimer = setTimeout(()=>fn.apply(this,args), ms);
  };
}

async function calculatePrice(){
  try {
    const qty = $('#qty').value || 1;
    const designe = 'Boutique'; // catalog default
    const qual = $('#quality').value;
    const fab = $('#fabrication').value;
    const addr = $('#city').value || '';

    const url = new URL(API_URL);
    url.searchParams.append('action','calculatePrice');
    url.searchParams.append('quantite', qty);
    url.searchParams.append('designe', designe);
    url.searchParams.append('qualite', qual);
    url.searchParams.append('fabrication', fab);
    url.searchParams.append('adresse', addr);

    const priceBox = $('#price-box');
    priceBox.textContent = 'Calcul en cours...';
    priceBox.insertAdjacentHTML('beforeend',' <span class="loader" id="price-loader"></span>');

    const res = await timeoutFetch(url.toString(), { method: 'GET' }, FETCH_TIMEOUT_MS);
    const json = await res.json();

    const loader = $('#price-loader');
    if (loader) loader.remove();

    if (json && json.status === 'success') {
      priceBox.textContent = 'Prix de Vente Calculé : ' + json.price;
    } else {
      priceBox.textContent = 'Erreur de calcul : ' + (json && json.message ? json.message : 'API indisponible');
    }
  } catch (err) {
    const loader = $('#price-loader');
    if (loader) loader.remove();
    $('#price-box').textContent = 'Erreur de connexion au serveur';
    console.error('calculatePrice error', err);
  }
}

async function submitOrder(){
  const btn = $('#submit-btn');
  const messageEl = $('#message');
  const form = $('#order-form');

  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  // build payload
  const payload = {
    token: API_TOKEN_IN_CLIENT || undefined,
    quantite: Number($('#qty').value) || 1,
    designe: 'Boutique',
    qualite: $('#quality').value,
    fabrication: $('#fabrication').value,
    ville: ($('#city').value || '').trim(),
    produit_selectionne: $('#selected-sku').value || '',
    nom_client: ($('#client-name').value || '').trim(),
    operateur: $('#operator').value,
    reference: ($('#trx-ref').value || '').trim()
  };

  // UI feedback
  btn.disabled = true;
  messageEl.innerHTML = '<div class="message" style="background:#f0f7ff;color:var(--accent)">Enregistrement en cours... <span class="loader"></span></div>';

  try {
    const res = await timeoutFetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }, FETCH_TIMEOUT_MS);

    const json = await res.json();
    if (json && json.status === 'success') {
      messageEl.innerHTML = `<div class="message success">${escapeHtml(json.message || 'Commande enregistrée avec succès')}</div>`;
      form.reset();
      $('#price-box').textContent = 'Prix de Vente Calculé : —';
      // show modal with payment reminder
      showModal('Commande enregistrée', `Merci — votre commande a été enregistrée.\n\nSi vous n'avez pas encore payé, envoyez le montant au numéro MTN: ${MTN_NUMBER} ou Airtel: ${AIRTEL_NUMBER} puis collez la référence reçue.`);
      setTimeout(()=>{ messageEl.innerHTML = ''; }, 6000);
    } else {
      messageEl.innerHTML = `<div class="message error">Erreur : ${escapeHtml(json && json.message ? json.message : 'Échec d\'enregistrement')}</div>`;
      console.error('API error', json);
    }
  } catch (err) {
    messageEl.innerHTML = `<div class="message error">Erreur de connexion au serveur. Réessayez.</div>`;
    console.error('submit error', err);
  } finally {
    btn.disabled = false;
  }
}

/* ============ Helpers ============ */
function showPayment(){
  showModal('Instructions paiement', `1) Envoyez le montant au numéro choisi.\n\nMTN: ${MTN_NUMBER}\nAirtel: ${AIRTEL_NUMBER}\n\n2) Après le paiement, copiez la référence reçue dans le champ "Référence de transaction" puis confirmez.`);
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ============ Init ============ */
document.addEventListener('DOMContentLoaded', ()=> {
  // nothing: user navigates via catalogue cards
});
</script>
</body>
</html>
